<!DOCTYPE html>
<html lang="en-IE">
<head>
    <title>C# Cloud IDE</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <!-- Using Prism.js for reliable syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-csharp.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --dark-bg: #0f0f0f;
            --editor-bg: #262626;
            --editor-border: #333333;
            --sidebar-bg: #252736;
            --card-bg: #2e2f42;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #3f4257;
            /*--accent: #ef4444;*/
            --accent: #2979ff;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            margin: 0 auto;
            padding: 20px 20px 20px 20px;
            color: #d4d4d4;
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 95vw;
            margin: 0 auto;
            gap: 20px;
        }
        
        h3{
            padding-left: 15px;
        }
        
        .child {
            background-color: var(--editor-border);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            padding: 10px 0 0 0;
            border: 1px solid var(--editor-border);
            overflow: hidden;
            scrollbar-color: var(--editor-border) var(--editor-bg);
            scrollbar-width: thin;
        }
        
        .console{
            min-width: 100%;
            min-height: 200px;
            height: calc(44.5vh - 5px);
        }

        /* Editor Container */
        .editor-container {
            position: relative;
            height: 72vh;
            overflow: hidden;
        }

        .editor-container::selection {
            background: #245b82;
        }

        /* Textarea that's actually editable */
        #code {
            width: 100%;
            height: 100%;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            background-color: var(--editor-bg);
            color: #d4d4d4;
            caret-color: #d4d4d4;
            resize: none;
            tab-size: 4;
            line-height: 1.5;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            margin: 0;
            padding: 10px 15px 10px 45px;
            border: none;
            outline: none;
            white-space: pre;
        }

        /* Syntax highlighted overlay */
        #highlighted-code {
            width: 100%;
            height: calc(100% - 20px);
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            background-color: transparent;
            color: transparent;
            resize: none;
            tab-size: 4;
            line-height: 1.5;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            margin: 0;
            padding: 10px 15px 10px 45px;
            pointer-events: none;
            white-space: pre;
            overflow: hidden;
        }

        /* Console Styles */
        .log-content {
            height: calc(36vh);
            background-color: var(--editor-bg);
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid var(--editor-border);
        }
        
        .button-clear{
            background: none; 
            border: none; 
            color: var(--accent); 
            cursor: pointer; 
            padding: 4px 8px;
        }

        /* Button Styles */
        #run {
            background-color: var(--accent);
            color: #fafafa;
            border: 1px solid var(--accent);
            padding: 10px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 10px;
            margin-left: 15px;
            cursor: pointer;
            border-radius: 5px;
        }

        #run:hover {
            border: 1px solid black;
        }

        /* Line numbers */
        .line-numbers {
            position: absolute;
            top: 10px;
            left: 10px;
            height: calc(100% - 20px);
            overflow: hidden;
            z-index: 5;
            padding-right: 10px;
            text-align: right;
            color: #858585;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            user-select: none;
        }

        /* Visual Studio-like syntax highlighting */
        .token.keyword { color: #569cd6 !important; }
        .token.type { color: #4ec9b0 !important; }
        .token.string { color: #ce9178 !important; }
        .token.comment { color: #57a64a !important; }
        .token.number { color: #b5cea8 !important; }
        .token.punctuation { color: #d4d4d4 !important; }
        .token.method { color: #dbdb93 !important; }
        .token.namespace { color: #d4d4d4 !important; }
        .token.operator { color: #d4d4d4 !important; }
        .token.class-name { color: #44c8af !important; }

        .loader-container{
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loader {
            display: none;
            width: 48px;
            height: 48px;
            border: 3px solid #FFF;
            border-radius: 50%;
            position: relative;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader::after {
            content: '';
            box-sizing: border-box;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 3px solid;
            border-color: var(--error) transparent;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--editor-border);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            z-index: 10;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; gap: 10px">
        <div class="child" style="width: 65%">
            <form style="margin-block-end: 0">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="padding-bottom: 8px; font-weight: 600;">
                        <svg aria-hidden="true" style="height: 16px" focusable="false" data-prefix="far" data-icon="code" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
                            <path fill="var(--accent)" d="M399.1 1.1c-12.7-3.9-26.1 3.1-30 15.8l-144 464c-3.9 12.7 3.1 26.1 15.8 30s26.1-3.1 30-15.8l144-464c3.9-12.7-3.1-26.1-15.8-30zm71.4 118.5c-9.1 9.7-8.6 24.9 1.1 33.9L580.9 256 471.6 358.5c-9.7 9.1-10.2 24.3-1.1 33.9s24.3 10.2 33.9 1.1l128-120c4.8-4.5 7.6-10.9 7.6-17.5s-2.7-13-7.6-17.5l-128-120c-9.7-9.1-24.9-8.6-33.9 1.1zm-301 0c-9.1-9.7-24.3-10.2-33.9-1.1l-128 120C2.7 243 0 249.4 0 256s2.7 13 7.6 17.5l128 120c9.7 9.1 24.9 8.6 33.9-1.1s8.6-24.9-1.1-33.9L59.1 256 168.4 153.5c9.7-9.1 10.2-24.3 1.1-33.9z"></path>
                        </svg>
                        Code
                    </h3>
                    <button id="clear-code-editor" class="button-clear">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Clear
                    </button>
                </div>
                <div class="editor-container">
                    <div class="line-numbers" id="line-numbers"></div>
                    <pre id="highlighted-code"><code class="language-csharp" id="highlighted-content"></code></pre>
                    <textarea autofocus id="code" name="code" spellcheck="false"></textarea>
                </div>
            </form>
            <button id="run">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Run (Ctrl+Shift+B)
            </button>
        </div>
        <!--Console-->
        <div class="consoles" style="min-width: 40%; max-width: 40%">
            <div class="child console" style="margin-bottom: 10px">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="margin: 0; font-weight: 600;">
                        <svg aria-hidden="true" style="height: 16px" focusable="false" data-prefix="far" data-icon="terminal" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                            <path fill="var(--accent)" d="M6.3 72.2c-9-9.8-8.3-24.9 1.4-33.9s24.9-8.3 33.9 1.4l184 200c8.5 9.2 8.5 23.3 0 32.5l-184 200c-9 9.8-24.2 10.4-33.9 1.4s-10.4-24.2-1.4-33.9L175.4 256 6.3 72.2zM248 432H552c13.3 0 24 10.7 24 24s-10.7 24-24 24H248c-13.3 0-24-10.7-24-24s10.7-24 24-24z"></path>
                        </svg>
                        Output
                    </h3>
                    <button id="clear-output-console" class="button-clear">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Clear
                    </button>
                </div>
                <div class="log-content" id="log-output">
<!--                    <div class="loader-container">-->
<!--                        <span class="loader" id="spinner"></span>-->
<!--                    </div>-->
                </div>
            </div>
            <div class="child console" style="width: 100%; min-width: 100%">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="margin: 0; font-weight: 600;">
                        <svg aria-hidden="true" style="height: 16px" focusable="false" data-prefix="far" data-icon="terminal" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                            <path fill="var(--accent)" d="M6.3 72.2c-9-9.8-8.3-24.9 1.4-33.9s24.9-8.3 33.9 1.4l184 200c8.5 9.2 8.5 23.3 0 32.5l-184 200c-9 9.8-24.2 10.4-33.9 1.4s-10.4-24.2-1.4-33.9L175.4 256 6.3 72.2zM248 432H552c13.3 0 24 10.7 24 24s-10.7 24-24 24H248c-13.3 0-24-10.7-24-24s10.7-24 24-24z"></path>
                        </svg>
                        System
                    </h3>
                    <button id="clear-system-console" class="button-clear">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Clear
                    </button>
                </div>
                <div class="log-content" id="log-system"></div>
            </div>
        </div>
    </div>
</div>
<div class="status-bar">
    <div class="status-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <span>Ready</span>
    </div>
    <div class="status-item">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
        <span>C#</span>
    </div>
</div>

<script type="module" src="wasmRunner.js"></script>
<script type="text/javascript" src="logger.js"></script>
<script type="module">
    import { run, preload } from './wasmRunner.js';
    
    const codeTextarea = document.getElementById('code');
    const highlightedContent = document.getElementById('highlighted-content');
    const lineNumbers = document.getElementById('line-numbers');
    const highlightedCode = document.getElementById('highlighted-code');
    const runButton = document.getElementById('run');
    const statusItem = document.querySelector('.status-item span');
    const statusBar = document.querySelector('.status-bar');

    // Initial code
    const initialCode = `using System;

namespace cloudIDE;

public class Program
{
	public void Main(string[] args)
	{
		Console.WriteLine("Hello, WebAssembly!");

		for (int i = 5; i < 10; i++)
			Console.WriteLine(Fibonacci(i));
	}

	public static int Fibonacci(int n)
	{
		if (n == 0) return 0;
		if (n == 1) return 1;
		return Fibonacci(n - 1) + Fibonacci(n - 2);
	}
}`;

    const storedValue = localStorage.getItem("cloudIDE");
    
    // Set initial code
    codeTextarea.value = storedValue == null ? initialCode : storedValue;
    updateHighlightedCode();
    
    // Update the highlighted code when typing
    codeTextarea.addEventListener('input', () => {
        updateHighlightedCode();
        localStorage.setItem("cloudIDE", codeTextarea.value);
    });
    codeTextarea.addEventListener('scroll', syncScroll);

    // Clear console buttons
    document.getElementById('clear-output-console').addEventListener('click', () => {
        document.getElementById('log-output').innerHTML = '';
    });
    document.getElementById('clear-system-console').addEventListener('click', () => {
        document.getElementById('log-system').innerHTML = '';
    });
    document.getElementById('clear-code-editor').addEventListener('click', (e) => {
        e.preventDefault();
        codeTextarea.value = initialCode;
        updateHighlightedCode();
    });

    // Keyboard shortcut for running code
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'B') {
            e.preventDefault();
            runButton.click();
        }
    });

    // Prevent tab from jumping focus out of editor
    codeTextarea.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            let start = this.selectionStart;
            let end = this.selectionEnd;

            // set textarea value to: text before caret + tab + text after caret
            this.value = this.value.substring(0, start) + "\t" + this.value.substring(end);

            // put caret at right position again
            this.selectionStart = this.selectionEnd = start + 1;
        }
    });

    // Update line numbers
    function updateLineNumbers() {
        const lines = codeTextarea.value.split('\n');
        lineNumbers.innerHTML = '';
        for (let i = 0; i < lines.length; i++) {
            lineNumbers.innerHTML += `<div>${i + 1}</div>`;
        }
    }

    // Update syntax highlighting using Prism
    function updateHighlightedCode() {
        highlightedContent.textContent = codeTextarea.value;
        Prism.highlightElement(highlightedContent);
        updateLineNumbers();
    }

    // Sync scrolling between textarea and highlighted overlay
    function syncScroll() {
        highlightedCode.scrollTop = codeTextarea.scrollTop;
        highlightedCode.scrollLeft = codeTextarea.scrollLeft;
        lineNumbers.scrollTop = codeTextarea.scrollTop;
    }

    await preload();
    
    document.getElementById("run").onclick = async () => {
        document.getElementById("log-output").innerHTML = '';
        document.getElementById("log-system").innerHTML = '';
        
        try {
            await run(codeTextarea.value);
            statusItem.textContent = 'Execution completed';
            statusBar.style.color = 'var(--success)';
        } catch (error) {
            statusItem.textContent = 'Error';
            statusBar.style.color = 'var(--error)';
            const output = document.getElementById('log-output');
            const text = (JSON && JSON.stringify ? JSON.stringify(error) : error) + '<br />'
            output.innerHTML += "> " + text;
        } finally {
            setTimeout(() => {
                statusItem.textContent = 'Ready';
                statusBar.style.color = 'var(--text-secondary)';
            }, 2000);
        }
    };
</script>
</body>
</html>